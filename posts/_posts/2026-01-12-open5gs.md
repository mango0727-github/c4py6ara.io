---
layout: post
title: Cellular network simulation--Open5GS and UERANSIM
description: >
  This post covers details on Open5GS and UERANSIM configurations and related 5GC and RAN network architecture. For installation procedures for Open5GS and UERANSIM, you can look around some other various posts and Youtube contents, and most importantly vendor-provided manuals. In this post, AMF, one of cellular network functions is mainly covered.
sitemap: false
math: true
hide_last_modified: true
---

# Cellular network simulation--Open5GS and UERANSIM

## Before reading

Open5GS is a widely used open-source implementation of 5G core network functions. While major cellular vendors naturally rely on proprietary testbeds, Open5GS fills a different—and increasingly important—gap: it offers researchers and security practitioners a practical, modifiable 5G core that can be deployed on commodity hardware.

There is no shortage of installation guides for Open5GS and UERANSIM. However, many of them stop right after “it works.” This post takes a different approach. I will walk through the key configuration parameters (especially those in AMF/SMF/UPF) and explain what each of them means in terms of the actual 5G architecture and interfaces (SBI, NGAP/N2, GTP-U/N3, and beyond). The goal is to help you understand not only how to run a 5G core, but also why specific settings matter—so you can debug failures faster and reason about security and design trade-offs more confidently.

Therefore, this post targets a different pain point:

> “I can run it, but I don’t understand why these YAML knobs exist, and how they map to actual 5G architecture and 3GPP interfaces.”

So we will:

- Connect UE.yaml, gNodeB.yaml, AMF.yaml to the 3GPP reference points (N1/N2/N3) and the Service-Based Architecture (SBA).
- Walk through the registration, authentication, and PDU session flow and show which config fields are actually working.
- Explain the meaning of multiple IPs you might see (e.g., `127.0.0.1` vs `127.0.0.5`, or `10.45.0.1`) and how to validate what is really binding where.

Assumption: you are running a single-host lab where Open5GS core, UERANSIM gNB, and UERANSIM UE run either on the same VM or in the same L2 domain.

---

## Prerequisites

### The 5G reference points

3GPP defines key reference points like this:

- N1: UE ↔ AMF, which becomes NAS messages (Registration Request, Authentication Response, Security Mode Complete, etc.). These are carried inside the access network control plane.
- N2: RAN ↔ AMF, which becomes NGAP over SCTP (gNodeB ↔ AMF), where NAS is transported to the core.
- N3: RAN ↔ UPF, which becomes GTP-U user plane (gNodeB ↔ UPF), for actual IP traffic after a PDU session is established.


> *NAS (Non-Access Stratum) messages* are the core control-plane signaling exchanged between the UE and the AMF in the 5G Core. “Non-Access Stratum” means these procedures are logically above/beyond the radio access-specific layers (the Access Stratum, AS). NAS covers key procedures such as Registration, Authentication (AKA), NAS Security Mode control, mobility management, and (in many cases) session management signaling. In 3GPP architecture, N1 is the reference point between UE and AMF. Importantly, the UE does not send NAS directly to the AMF over an IP path. Instead, NAS is delivered via the RAN, i.e., the UE hands NAS to the gNodeB, and the gNodeB transports it to the AMF. 

> *NGAP (Next-Gen Application Protocol)* is the application-layer protocol used on the N2 interface between the gNodeB and the AMF. You can think of NGAP as the “5G core-facing control protocol” for the RAN. It serves (1) RAN-level control procedures (e.g., UE context management, mobility/handover-related control events, and other RAN notifications to the AMF), and (2) acting as a transport container for NAS, carrying UE↔AMF NAS messages across the gNodeB↔AMF boundary. This leads to a useful mental model, i.e., N1 is the logical UE↔AMF signaling (NAS), while N2 is the physical control-plane link that actually carries that signaling in practice (NAS inside NGAP). On N2, NGAP typically runs over *SCTP (Stream Control Transmission Protocol)*. SCTP is widely used for telecom signaling because it provides features that are beneficial for control-plane traffic, such as multi-streaming. These properties align well with NGAP’s procedure-oriented signaling.

> *GTP-U (General Packet Radio Service Tunnelling Protocol – User plane)* is the protocol used to carry user data (the user plane) through a tunnel between the gNodeB and the UPF (User Plane Function) on the N3 interface. The key idea is tunneling, i.e., rather than forwarding UE IP packets end-to-end, the RAN and core user plane establisha tunnel and encapsulate UE packets inside GTP-U for transport across the access and core boundary. *A PDU (Protocol Data Unit) Session* is the logical connectivity association that allows the UE to exchange IP (or other PDU types) with a Data Network, e.g., the public Internet. When a PDU Session is successfully established, the UE is typically assigned an IP address, and the network sets up the corresponding user-plane path. This includes creating GTP-U tunnel state between the gNodeB and the UPF (identified by TEIDs).



### Service-Based Architecture (SBA)

In 5GC, many control-plane interactions are HTTP-based services. AMF exposes services under NAMF, with Stage-3 details in TS 29.518.

In Open5GS config, that shows up as:

- `amf.sbi.server`: where AMF exposes HTTP APIs
- `amf.sbi.client`: where AMF reaches other NF services such as NRF, SCP, etc.

### 127.0.0.x

#### Loopback addresses such as `127.0.0.5`, `127.0.0.10`, etc.

This Open5GS lab binds different NFs to different loopback addresses so everything runs on one host but still looks like multiple NF endpoints.

Example mapping you might see:

- AMF on `127.0.0.5`
- NRF on `127.0.0.10`
- SCP on `127.0.0.200`

This is not real operator addressing, however it is a convenient single-host emulation. Also, it would show a very straight forward high-level overview on how 5GC works with different network functions (or endpoints).

---

## Three configuration files to be covered

In this lab, I will touch three YAML files:

- `UE.yaml` (UERANSIM UE): defines subscriber identity, authentication material, and what session or slice the UE requests
- `gNodeB.yaml` (UERANSIM gNodeB): defines cell identity, where to reach AMF over N2 (NGAP), where to bind N3 (GTP-U)
- `AMF.yaml` (Open5GS AMF): defines where AMF listens for N2, where AMF exposes SBI, which slice it serves and security preferences

A useful concept model is to map them to interfaces first, then to procedures as follows:

| Interface | Protocol (common) | Direction | Where configured |
|---|---|---|---|
| N1 | NAS (inside RAN control plane) | UE ↔ AMF | UE.yaml, AMF.yaml |
| N2 | NGAP over SCTP | gNB ↔ AMF | gNodeB.yaml, AMF.yaml |
| N3 | GTP-U over UDP | gNB ↔ UPF | gNodeB.yaml, UPF.yaml |
| SBA | HTTP/2 or HTTP | NF ↔ NF | AMF.yaml, NRF/SCP configs |

For this post, I will go deep on UE.yaml, gNodeB.yaml, AMF.yaml and show how they drive:
1. Registration  
2. Authentication and NAS security  
3. (Bridge to) PDU Session establishment and user plane considerations

---




## gNodeB.yaml (configuration for gNodeB)

Below is gNodeB.yaml script:
```yaml
mcc: '999'          # Mobile Country Code value
mnc: '70'           # Mobile Network Code value (2 or 3 digits)

nci: '0x000000010'  # NR Cell Identity (36-bit)
idLength: 32        # NR gNB ID length in bits [22...32]
tac: 1              # Tracking Area Code

linkIp: 127.0.0.100   # gNB's local IP address for Radio Link Simulation (Usually same with local IP)
ngapIp: 127.0.0.200   # gNB's local IP address for N2 Interface (Usually same with local IP)
gtpIp: 127.0.0.201    # gNB's local IP address for N3 Interface (Usually same with local IP)

# List of AMF address information
amfConfigs:
  - address: 127.0.0.5
    port: 38412

# List of supported S-NSSAIs by this gNB
slices:
  - sst: 1

# Indicates whether or not SCTP stream number errors should be ignored.
ignoreStreamIds: true
```

Let me focus on the lines:
```yaml
linkIp: 127.0.0.100   # gNB's local IP address for Radio Link Simulation (Usually same with local IP)
ngapIp: 127.0.0.200   # gNB's local IP address for N2 Interface (Usually same with local IP)
gtpIp: 127.0.0.300    # gNB's local IP address for N3 Interface (Usually same with local IP)
```
The lines configure addresses for gNodeB to operate between UEs and the AMF. `linkIp` is the local address used by UERANSIM to emulate the UE–gNB radio link in an RF-less lab setup. So, it does not have to do with the real-world setting. `ngapIp` is the local address the gNB binds to for N2 signaling (NGAP over SCTP) toward the AMF. `gtpIp` is the local address the gNB binds to for N3 user-plane tunneling (GTP-U over UDP) toward the UPF. The default IP addresses were the same as 127.0.0.1, but I changed them as are so that I can easily track the interfaces.


```yaml
amfConfigs:
  - address: 127.0.0.5
    port: 38412

# List of supported S-NSSAIs by this gNB
slices:
  - sst: 1
```
This block sets an address and a port number to which gNodeB reaches out for the AMF. Also, it is set to have only one S-NSSAI (Single-Network Slice Selection Assistance Information) where SST (slice/service type) is 1. If you can get familiar with it by googling the network slicing to see how S-NSSAI works. We can have multiple SSTs, however we are using only one SST now for simplicity.

It is demonstrated with Wireshark as:
<img width="1385" height="414" alt="image" src="https://github.com/user-attachments/assets/fd30fd39-bb14-48fb-99c6-7943e9ea6a57" />



THIS POST IS UNDER CONSTRUCTION
